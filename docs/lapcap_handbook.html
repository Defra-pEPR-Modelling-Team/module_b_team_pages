<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>LAPCAP Handbook</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
  <link rel="icon" type="image/png" href="favicon.ico"/>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="notitle.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">FPC Team Pages</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    New Starters
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="new_induction_stuff.html">Start here!</a>
    </li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">How to...</a>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="new_how_to_access_r_studio.html">...access R Studio</a>
        </li>
        <li>
          <a href="new_how_to_set_up_github.html">...set up Github</a>
        </li>
        <li>
          <a href="new_how_to_edit_github_code.html">...edit Github code</a>
        </li>
      </ul>
    </li>
  </ul>
</li>
<li>
  <a href="lapcap_library.html">LAPCAP Library</a>
</li>
<li>
  <a href="lapcap_plan.html">LAPCAP Plan</a>
</li>
<li>
  <a href="lapcap_handbook.html">LAPCAP Handbook</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Useful Bits
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="other_data_dictionary.html">Data Dictionary</a>
    </li>
    <li>
      <a href="other_glossary.html">Glossary</a>
    </li>
    <li>
      <a href="other_learning.html">Learning and Development</a>
    </li>
    <li>
      <a href="other_meeting_etiquette.html">Meeting Etiquette</a>
    </li>
    <li>
      <a href="other_common_problems.html">Common Problems</a>
    </li>
    <li>
      <a href="other_useful_links.html">Collected Links</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">LAPCAP Handbook</h1>

</div>


<div id="lapcap-handbook" class="section level1">
<h1>LAPCAP Handbook</h1>
<p>The LAPCAP handbook gives practical steps and detail for how model
development, quality assurance and signoff processes of LAPCAP and
should be used by FPC team members to carry out the processes
correctly.</p>
<p>For the background, theory and plan behind the approach you should
read the LAPCAP Plan.</p>
<p>The below diagrams give an overview of the processes, with more
detail included in later sections.</p>
<p><u>Coding Process Diagram</u> <img
src="assets/bible_process_1.png" /></p>
<p><u>Signoff Process Diagram</u> <img
src="assets/bible_process_2.png" /></p>
<div id="coding-process-detail" class="section level2">
<h2>Coding Process Detail</h2>
</div>
<div id="decide-to-change-code" class="section level2">
<h2>1. Decide to change code</h2>
<p>The modelling team, led by G7s, will identify the most important
changes needed ahead of the next release of modelling outputs.</p>
<p>They may choose to make use of the Analytical Board, TWG or Sounding
Board in determining this. They may also choose to seek signoff of their
plans from the model owner or project board, or to simply make them
aware, to ensure planned changes are expected.</p>
<p>An agile methodology using Jira is then used to plan out the delivery
of these changes. Time for quality assurance should
<strong>ALWAYS</strong> be built into each ticket in this planning, it
should be understood that if there is not time for quality assurance
then there is not time for the work.</p>
</div>
<div id="make-changes-to-code" class="section level2">
<h2>2. Make changes to code</h2>
<p>Team members will then take ownership of individual tasks, which
should be clearly laid out in a single Jira ticket. Tasks should be as
short and defined as possible with a clear endpoint. Story points will
be used to make sure each team member has an appropriate workload in
each sprint. With sprints lasting two weeks team members should be able
to take on approximately 8 story points (estimated to be 8 days of work)
in addition to their other responsibilities.</p>
<p>During completion of a ticket, changes will be made to the existing
LAPCAP model through R Studio and Github. In order for multiple team
members to work on the model at once we use Git, instructions for how to
set this up can be found in the <a href="new_induction_stuff.html">new
starter section</a>, whilst details on our use of branches can be found
in the <a href="#model_tagging">Model Versioning</a> section.</p>
<p>In addition to changing the code, you may need to take additional
steps, as follows:</p>
<div
id="a.-if-the-changes-involve-adding-removing-or-changing-an-assumption-then-the-modelling-team-member-must-update-the-relevant-assumption-log"
class="section level4">
<h4>a. If the changes involve <strong>adding, removing or changing an
assumption</strong> then the modelling team member must update the
relevant assumption log:</h4>
<details>
<summary>
How to change an assumption
</summary>
<p><a id="how_to_assumption"></a></p>
<ol style="list-style-type: decimal">
<li><p><strong>Identify an assumption.</strong></p>
<p>We define assumptions as <strong>“choices analysts make to correct
for low quality or absent data or information, that knowingly introduce
inaccuracy into our outputs.”</strong></p>
<p>Questions to help you determine whether a section of code is an
assumption could be:</p>
<ul>
<li>Have you had to make a specific choice for how to model?</li>
<li>Is your choice a simplification of reality?</li>
<li>Theoretically were there other choices you could have made?</li>
<li>Would changing your choice affect the final number?</li>
<li>Is this information recorded elsewhere (e.g. in a data log or the
technical document)?</li>
</ul></li>
<li><p><strong>Record your assumption in-code.</strong></p>
<p>Paste the following code snippet below the relevant portion of code
and edit to reflect the above.</p>
<pre class="r"><code># Assumption: Title of assumption
# Quality: RED
# Impact: AMBER
# Detailed description
# on one line or many.</code></pre>
<p>The title of the assumption should be short, clear and unique to this
assumption.</p>
<p>The RAG rating is a red, amber or green rating summarising both the
quality (e.g. how confident we are) and impact (e.g. how much model
outputs are likely to be affected) of the assumption.</p>
<p>The detail description should give all information needed for someone
to understand the assumption, including why an assumption is needed, why
you have made the choice and more.</p>
<p>For more info on the package behind our assumptions log go to: <a
href="https://assumptions.readthedocs.io/en/latest/index.html">Assumptions
1.1.0 Docs</a>.</p></li>
<li><p><strong>Record your assumption in the relevant assumptions
log.</strong></p>
<p>Each module has its own assumptions log which you can find via the
LAPCAP library.</p>
<p>You will need to fill out the following fields:</p>
<ul>
<li><p>ID <em>- prefilled</em></p></li>
<li><p>Assumption title <em>- same as reported in code</em></p></li>
<li><p>Detailed description <em>- same as reported in code</em></p></li>
<li><p>Reporter <em>- your name</em></p></li>
<li><p>Script(s) <em>- which R script the assumption can be found
in</em></p></li>
<li><p>Line(s) in code <em>- which lines in the script are
relevant</em></p></li>
<li><p>RAG <em>- same as reported in code</em></p></li>
<li><p>RAG explanation <em>- an explanation for why you gave the above
RAG rating</em></p></li>
<li><p>Links to supporting evidence <em>- any supporting evidence that
you used in formulating this assumption, which should be stored in the
corresponding ‘Supporting Evidence’ folder</em></p></li>
</ul></li>
</ol>
</details>
<p><br></p>
</div>
<div
id="b.-if-the-changes-involve-updating-a-data-import-then-the-data-pipeline-must-be-refreshed-and-data-logs-updated"
class="section level4">
<h4>b. If the changes involve <strong>updating a data import</strong>
then the data pipeline must be refreshed and data logs updated:</h4>
<details>
<summary>
How to modify the data pipeline
</summary>
<p><a id="how_to_data_input"></a></p>
<p>We have separated the code that processes our data inputs from the
rest of the model,. this code is known as the <em>data pipeline</em>.The
data pipeline is our way of version controlling input data for LAPCAP,
meaning we can run previous versions of the model even if inputs have
changed.</p>
<p>It works by reading the raw data inputs from AWS S3, processing them
in R and then saving them back to AWS in a new version specific
location. The model can then read from this location.</p>
<p>Therefore if you need to change, add or remove a data input or the
way it is processed, you will need to edit the data pipeline. Guidance
for how to do this can be found below.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Before you do anything else change the
<code>model_version</code> parameter in any calls to the ‘data_pipeline’
function to a placeholder.</strong></p>
<p>This will prevent you from accidentally overwriting data being used
by the “live” model, when working on the data pipeline itself
(experimentation, testing, logic changes etc.) or updating/changing a
data source,and ensures rolling-back to versions is easy in the
future.</p>
<p>The pipeline will tell you if you are going to overwrite any data,
but care should still be taken.</p>
<p>You should use a unique string for your model_version parameter
e.g. “your_name_test”. This will be changed later when merging into
dev.</p></li>
<li><p><strong>Experiment and make the changes needed to the
code.</strong></p>
<p>Ensure you add the file_path and file_log logic to any new import
functions (see the other import functions for details) – this will
capture the new data sources in the file log.</p>
<p>If you are modifying the pipeline itself, you should note:</p>
<ul>
<li>There are dependencies between the sub-pipelines (e.g. waste flow
using data from scheme data), so they will need to be run in order in
any experimentation.</li>
<li>If you are running pipeline functions outside of the pipeline
itself, you will likely need to define the following variables:</li>
</ul>
<pre class="r"><code>s3_bucket &lt;- &quot;s3-ranch-043&quot;
root_folder &lt;- &quot;Module_B1/Inputs&quot;
file_log &lt;- list()</code></pre></li>
<li><p><strong>Once you have finished your experimentation/changes,
update the model_version parameter to the next model
version.</strong></p>
<p>Follow the <a href="#model_tagging">Model Versioning guidance</a>) in
both the argument to <code>data_pipeline()</code> in
<code>update_data_pipeline.R</code> and the argument to
<code>run_LAPCAP_model()</code> in <code>main.R</code>.</p></li>
<li><p><strong>Run the pipeline to create a folder of data for that
model version.</strong></p>
<p>To run the data pipeline, run the <code>update_data_pipeline.R</code>
script. This will update to the latest version of the LAPCAP package,
load all of the pipeline scripts, and run the pipeline (including saving
the outputs to the aws bucket). This will create a new folder of
processed data at “Module_B1/Inputs/Processed/” named after the
model_version parameter.</p>
<ol style="list-style-type: lower-alpha">
<li>If adding a data input, you should add it to the appropriate data
log also.</li>
</ol></li>
<li><p><strong>Open a PR, follow QA processes and merge your changes
into dev</strong></p>
<p>Also delete any temporary folders you created in aws using your
temporary model_version parameter.</p></li>
<li><p><strong>Follow the Model Versioning guidance about tagging the
new model version on dev</strong></p></li>
</ol>
</details>
<p><br></p>
</div>
<div
id="c.-if-model-logic-is-changed-then-the-technical-document-and-unit-tests-must-be-updated-accordingly."
class="section level4">
<h4>c. If <strong>model logic is changed</strong> then the technical
document and unit tests must be updated accordingly.</h4>
<details>
<summary>
How to update the technical document
</summary>
<p><a id="how_to_tech_doc"></a></p>
<ol style="list-style-type: decimal">
<li><p><strong>Decide whether you need to change the technical
document.</strong></p>
<p>If your changes to the model you have created have changed the
functionality of the model then you should update the relevent section
of the technical document.</p>
<p>Furthermore, if a calculation is added or modified, then the example
calculations section should also be updated.</p>
<p>No matter what, if a new script is added to the model (not the
pipeline), the technical document should also be edited, even if there
are no actual changes to model functionality. The related content
section for the relevant module should be updated with the name of the
new file created. This is because when the markdown is created it checks
that all files have been covered in the technical document.</p></li>
<li><p><strong>Edit the technical document working draft.</strong></p>
<p>All updates to the technical document should first be written in the
Microsoft Word based technical document working draft document stored in
the model master folder. The sections of the technical document mirror
the model modules, so it should be easy to find the sections you need to
edit.</p>
<p>Some tips for writing high quality technical documents/example
calculations include:</p>
<ol style="list-style-type: decimal">
<li>Ensure you explain the model in terms that a non-technical person
can understand</li>
<li>Use as many diagrams as possible to aid understanding</li>
<li>Use example calculations/equations frequently</li>
<li>Don’t use any language like “I” or “we”</li>
<li>If you are not sure how to write your section then read some other
sections for guidance or ask someone to help.</li>
<li>If you are updating the example calculations section there should be
no surprises! Each variable you mention should have previously mentioned
or you need to say where it has come from.</li>
<li>All equations in example calculations should follow through.</li>
</ol></li>
<li><p><strong>Open a PR, follow QA processes and merge your changes
into dev</strong></p>
<p>As part of this, your reviewer should check the changes you have made
to the technical document are adequate, so signpost what you have done
in your PR.</p></li>
<li><p><strong>Your role may end here, however in order to publish the
technical document we have some additional steps.</strong></p>
<p>The final technical document should be created using markdown,
however, before any changes are made to the markdown, the following must
happen.</p>
<ol style="list-style-type: decimal">
<li>All updates to the working draft technical document should be
checked. When the word document has been fully approved, only then
should the markdown file be changed. (This is for your ease of use as it
is much easier to edit a word document).</li>
<li>All new files that have been covered in the updated technical
document should be added to the related contents section in the markdown
code.</li>
<li>You should run the <code>generate_technical_document</code> function
to check which files are not covered in the technical document. It may
be fine for these files to not be covered, but if they include important
functionality then update the technical document.</li>
<li>The technical document should be sent to relevant parties who want
to check it. This should include the FPC team, members of adjoining
teams, the G6 (Tristan), and any other people you think might want to
add input.</li>
<li>The HTML version of the example calculations section should be sent
to the contents team to check if there are any significant changes. This
is subject to it still being included in the LA guidance and
published.</li>
</ol></li>
</ol>
</details>
<p><br></p>
<details>
<summary>
How to write a unit test
</summary>
<p><a id="how_to_unit_test"></a></p>
<p>Unit tests are automated checks that verify individual functions or
modules behave as expected. They act as a safety net when changing or
adding features, ensuring existing functionality remains unchanged.</p>
<p>Unit tests should be used during development and whenever you run the
model. You can find all unit tests in the LAPCAP model in the
<code>~/module_b/LAPCAP/tests</code> folder. You should be able to click
on any one of them and run them as any normal function
(Ctrl+Shift+Enter). After which the test results will appear in the
“Console” pane. You will see messages like “Test passed” or error
messages if something goes wrong.</p>
<p>If you wish to run them all at the same time you can use:
“testthat::test_dir(”~/module_b/LAPCAP/tests”)” which will execute all
the files in that location.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Identify whether a test is needed, and what
sort.</strong></p>
<p>Unit tests should be used to test important model functionality, this
may mean an individual function, or many. They should be included
anywhere a failing function will impact model outputs.</p>
<p>Unit tests generally fall into three categories.</p>
<ul>
<li><strong>Normal operation tests</strong>, verify the core
functionality of the code using typical inputs. <strong>Most of our
tests should be like this.</strong></li>
<li><strong>Error fixing tests</strong>, confirm that known problematic
inputs (e.g., NAs, zeros, negatives, mismatched names) are correctly
handled or “fixed.”</li>
<li><strong>Error catching tests</strong>, ensure that inappropriate
inputs trigger proper error messages and stop execution as
intended.</li>
</ul>
<p>Identify what it is about the model you want to ensure is protected
and select a type of test that can do this.</p></li>
<li><p><strong>Get your test input data.</strong></p>
<p>Most unit tests function by comparing expected and actual results of
a function on a fixed set of input data.</p>
<p>So we need fixed inputs in order to test our functions:</p>
<ol style="list-style-type: lower-alpha">
<li>Start by obtaining some real or dummy input data (or a subset of it)
for the section of code you are testing.</li>
<li>Apply the dput function to your downsized datasets. This will output
(in the console) code that can be used to produce your dummy dataset as
required.</li>
</ol>
<p>If you are testing error fixing or catching you may wish to
intentionally introduce some incorrect data here.</p></li>
<li><p><strong>Get your output data.</strong></p>
<p>Either manually or by using code you know to be correct, generate the
outputs that should result from running the test input data through your
function.</p>
<p>If you are testing error catching there may not be a correct output,
an error message may be expected instead.</p></li>
<li><p><strong>Write your test.</strong></p>
<p>We use the testthat package, which provides functions like
expect_equal, expect_identical, and expect_error that allow you to
compare actual and expected outcomes.</p>
<p>A template is provided below, you should add detail to the
description as well as changing object names:</p>
<pre class="r"><code>#&#39; @title Unit test 1 
#&#39; @description Tests the normal operation of function_name [ADD DETAIL] 

testthat::test_that(&quot;function name normal operation test&quot;, { 

#Create dummy data 
function_name_ut1_input_data_1 &lt;- #Paste dput of first three or four rows and relevant columns of dataset 
function_name_ut1_input_data_2 &lt;- #Same again 

function_name_ut1_output_data &lt;- #Paste dput of expected outputs or write code to manually calculate these 

#Test 
testthat::expect_equal( 
  function_name( 
    function_name_ut1_input_data_1, 
    function_name_ut1_input_data_2 
    ), 
    function_name_ut1_output_data
  ) 
})</code></pre>
<p>It is important to name your test files clearly (e.g.,
test_inflate_costs.R, test_align_facility.R) so that it is immediately
obvious which module or function each test is verifying.</p></li>
<li><p>Finally you should run your unit tests to ensure they pass, and
also tweak your functions to check they fail when they should. This will
also be reviewed as part of your pull request.</p></li>
</ol>
</details>
<p><br></p>
</div>
<div
id="d.-if-the-changes-will-affect-model-outputs-then-validation-checks-must-be-carried-out."
class="section level4">
<h4>d. If the <strong>changes will affect model outputs</strong>, then
validation checks must be carried out.</h4>
<details>
<summary>
How to run validation checks
</summary>
<p><a id="how_to_validate"></a></p>
<p>Validation checks ensure the model is performing as we expect. We
currently have three validation processes in place, outlined below.
These have been mostly automated so should be easy!</p>
<ol style="list-style-type: decimal">
<li><p><strong>Change log</strong></p>
<p>This allows us to check the percentage difference between the outputs
from the last tagged version of LAPCAP and the output of whatever
changes you have made.</p>
<p>This should be done via the spreadsheet named “[model_version] model
output sensitivity testing.xlsx” on the Module B1 Sharepoint, within <a
href="https://defra.sharepoint.com/:f:/r/teams/Team1478/Extended%20Producer%20Responsibility%20for%20Packaging/07%20Fees%20and%20Payments%20Calculator/18%20Module%20B1%20-%20LA%20FNCs/04%20Bottom-up%20Modelling/00%20Model%20Master?csf=1&amp;web=1&amp;e=1jREhl">00
Model Master folder</a> &gt; [model_version].</p>
<p>Follow the comprehensive instructions in the first sheet.</p>
<p>The spreadsheet automatically highlights any percentage changes above
the acceptable threshold. If values become highlighted, make sure to
check with a Grade 7 whether the need for the change justifies the
change in outputs.</p></li>
<li><p><strong>Critical Success Factors (CSF) markdown</strong></p>
<p>We generate and inspect the Critical Success Factors (CSF) markdown
to ensure the change hasn’t violated any of the success factors. These
success factors are the principles that the model has to meet, as agreed
by the four nations.</p>
<p>Use the function generate_validation_markdowns() in documents in the
LAPCAP repo to generate the markdown, following the instructions in the
function’s roxygen header</p>
<p>Inspect the output, ensuring that each CSF is still being met. If you
have any concerns, raise them with a G7 or above.</p>
<p>Download a version of the output so you can link it in the pull
request template later.</p></li>
<li><p><strong>Internal Validation markdown</strong></p>
<p>PROCESS TBD - STILL IN DEVELOPMENT</p></li>
</ol>
</details>
<p><br></p>
<p>Locations for assumption log, data log or the technical document can
be found in the LAPCAP library, and each includes further instructions
for how to use it.</p>
<p>Once you have satisfied the requirements of your ticket, all of the
above have been addressed and you are ready for someone to review your
work, you should make a pull request via Github.</p>
<details>
<summary>
How to make a pull request
</summary>
<p><a id="how_to_pull_request"></a></p>
<p>Once the modelling team member has completed their changes, they
should make a pull request and request a review from another member of
the team.</p>
<p>Here are the <strong>step-by-step instructions</strong> to submit a
pull request:</p>
<ol style="list-style-type: decimal">
<li><p>Go to the relevant repo on Github and navigate to your branch</p>
<ol style="list-style-type: lower-alpha">
<li><p>Use either the branches drop down or click on ‘<em>x
branches</em>’ to go to the branches page and select your branch.</p>
<p><img src="assets/branches_button.png" /></p></li>
</ol></li>
<li><p>If your push was recent there may be a pop up allowing you to
‘<em>compare and pull request</em>’, if not then click
‘<em>Contribute</em>’ and ‘<em>Open pull request</em>’.</p>
<p><img src="assets/contribute_button.png" /></p></li>
<li><p>Make sure you are merging to the correct branch, this will
usually be <em>dev</em> (for code in development) or sometimes
<em>main</em> if it has been fully quality assured.</p>
<p><img src="assets/merge_to_dev.png" /></p></li>
<li><p>Fill out the pull request template (following carrying out
validation checks, see below), including adding any additional QA checks
to the list.</p>
<blockquote>
<p>Replace this gif with one that describes how you felt about
completing this ticket:</p>
<p><img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExaHB0bHQ4dzQ4anN5b3JoaDIyb2twOXh4Y3U5YWY1NHB6c3dreWdvNSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/gOfSjdLRr6SlvGQTe3/giphy.gif" height="150"/></p>
<p>✔️ <strong>QA checklists</strong></p>
<p>📝 <strong>Description of changes made:</strong></p>
<p>🎟️ <strong>Link to Jira ticket:</strong></p>
<p>🤔 <strong>Link to QA log (assumptions or data log), if
changed:</strong></p>
<p>💾 <strong>If appropriate, link to CSF markdown:</strong></p>
<p>📈 <strong>If appropriate, link to output percentage change
spreadsheet:</strong></p>
<table>
<thead>
<tr class="header">
<th></th>
<th>% change in EPR Total Net Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Mean absolute change per LA</strong></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Overall</strong></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>England</strong></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Scotland</strong></td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Wales</strong></td>
<td></td>
</tr>
<tr class="even">
<td><strong>NI</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p>🌜 <strong>Do-er QA checklist</strong></p>
<p>Before submitting a pull request the principle analyst
<strong>must</strong> have completed the below checks.</p>
<ul class="task-list">
<li><p><label><input type="checkbox" />Assumptions log has been updated
with any new or changed assumptions, including appropriate rationale
and/or evidence</label></p></li>
<li><p><label><input type="checkbox" />Data log has been updated with
any new or changed data</label></p></li>
<li><p><label><input type="checkbox" />If functional changes have been
made to code, the CSF markdown has been generated and inspected, and
there are no issues highlighted in visualisations</label></p></li>
<li><p><label><input type="checkbox" />If functional changes have been
made to code, the percentage change in model outputs has been calculated
and reported above, if the change is above threshold, this has been
raised with a Grade 7 or above.</label></p></li>
<li><p><label><input type="checkbox" />If additional checks are
required, these have been added to the Checker Checklist below, with
detailed instructions as to how to run the checks</label></p></li>
</ul>
</blockquote>
<p>Some suggestions for additional checks are included in the template
also:</p>
<blockquote>
<p><strong>Additional checks</strong></p>
<p>The below is a list of QA checks that reviewers may want to perform
in addition to the above. Note that this lists is <strong>not
exhaustive</strong> and it is the responsibility of the principle
analyst (do-er) and the QAer (checker) to ensure all items that need to
be checked have been:</p>
<ol style="list-style-type: decimal">
<li>Check that the calculations done are fit for purpose and are
correct</li>
<li>Check that uncertainty has been considered and appropriately
accounted for (e.g. has sensitivity analysis been performed)</li>
<li>Check that the data used is fit for purpose and the best option
available to us</li>
<li>Check that other appropriate documentation has been completed or
updated to an appropriate standard e.g. the technical document</li>
<li>Is the data being correctly pulled into the model?</li>
<li>Is the data being properly cleaned and manipulated (either before
the model or during the code)?</li>
<li>Has the data been verified and validated? Has it been checked for
potential errors? And has it been confirmed that the data appropriate to
use in the first place? Is it the best possible option?</li>
<li>Are there other results other than the outputs of the last model
that the results need to be compared to?</li>
<li>In cases where new data is added, or a change is heavily dependent
upon a particular data source, does the model respond as expected to
extreme values, negatives, zeroes, NAs etc? Is it possible to break the
model with the data or generate impossible results?</li>
</ol>
</blockquote>
<p>These, or other checks, should be added to the checker’s checklist,
as appropriate, in the PR to ensure they are completing all the checks
required.</p></li>
<li><p>Click ‘<em>Reviewer</em>’ and select the person who has agreed to
review your code.</p>
<p><img src="assets/reviewers.png" /></p></li>
<li><p>Then you can click ‘<em>Create pull request</em>’.</p>
<ol style="list-style-type: lower-alpha">
<li>Once you have created the pull request you should move the ticket to
‘For Review’ on Jira.</li>
</ol></li>
</ol>
</details>
<p><br></p>
</div>
</div>
<div id="verify-the-changes" class="section level2">
<h2>3. Verify the changes</h2>
<p>Once assigned a review the team member must complete the full
checklist provided by the principle analyst. It is also the QAers must
also review the list critically and ensure that it is both appropriate
and sufficient. If the QAer feels otherwise they must raise this with in
the first instance the principle analyst and then failing this the model
owner.</p>
<p>You should use the checklist below, which is also included in the
pull request template, to ensure you carry out all necessary checks:</p>
<blockquote>
<p>🌛 Checker QA checklist</p>
<p>Before approving a pull request the reviewer must have completed the
below checks: In addition to the above, the following is a checklist for
the reviewer to use:</p>
<ul class="task-list">
<li><label><input type="checkbox" />The “do-er” checklist has been
completed to an appropriate standard, fields above the checklist have
been appropriately completed</label></li>
<li><label><input type="checkbox" />Code meets the requirements set out
in the Jira ticket</label></li>
<li><label><input type="checkbox" />All functions have roxygen headers
with <span class="citation">@description</span>, <span
class="citation">@param</span> and <span class="citation">@return</span>
fields, and comments in code are appropriate and sufficient</label></li>
<li><label><input type="checkbox" />The code runs when using an empty R
environment, without error</label></li>
<li><label><input type="checkbox" />Code follows the <a
href="https://style.tidyverse.org/">tidyverse</a> and <a
href="https://defra-pepr-modelling-team.github.io/module_b_team_pages/index.html">FPC
style guide</a>.</label></li>
<li><label><input type="checkbox" />No future risks have introduced by
this change e.g. hardcoded values that may change in the future, or if
they have they are adequately signposted and justified</label></li>
<li><label><input type="checkbox" />Code cannot be simplified
significantly, there is no redundancy in code and no changes to model
structure and dependant functions are needed, given the
changes.</label></li>
<li><label><input type="checkbox" />There are no further improvements
that can be made to the code</label></li>
<li><label><input type="checkbox" />Any additional QA checks appropriate
to, and sufficient for, the changes have been performed</label></li>
<li><label><input type="checkbox" />When submitting the final review, a
comment has been left that summarises the QA checks that have been
performed and the outcomes</label></li>
</ul>
</blockquote>
<p>Also you should carry out any additional checks required, which have
been added to the Checker Checklist by the doer.</p>
<p>Reviewers should trace the full logic of the code, both by reading
through it and by running it and spot-checking intermediate data frames.
They should inspect any relevant data imports both in R Studio and
directly from their original source. They should examine model outputs
before and after the changes to ensure they make sense. They should make
sure they are able to replicate any processes or calculations in the
code.</p>
<p>Reviewers should leave comments via GitHub, to ensure a record of
verification and validation. GitHub has several features to help with
this such as filtering changes by commit or file type, marking scripts
as viewed, making direct code suggestions and bundling many comments
into one review.</p>
<p>These reviews may go through one or more cycles of requesting
changes, in order for the reviewer to be happy. GitHub has functionality
to enable this.</p>
<p>The following explains the practical steps followed in when reviewing
code:</p>
<details>
<summary>
How to do a code review
</summary>
<p><a id="how_to_code_review"></a></p>
<p>This <a href="https://www.youtube.com/watch?v=lSnbOtw4izI">Github
code review tutorial</a> shows you how to review a pull request, or you
can follow the steps below.</p>
<p>Follow these step-by-step instructions to do a proper code
review:</p>
<ol style="list-style-type: decimal">
<li><p>Navigate to the ‘<em>pull request</em>’ that has been assigned to
you. Read the description provided and use the checklist to aid your
review.</p></li>
<li><p>Switch to the ‘<em>Files changed</em>’ tab to see the changes
made, here you can make comments and suggestions as you see fit by
clicking the blue plus to the left of the line you want to comment
on.</p>
<p><img src="assets/add_comment_button.png" /></p>
<ol style="list-style-type: lower-alpha">
<li>Make sure to tick ‘<em>Start a review</em>’ rather than ‘<em>Add
single comment</em>’.</li>
<li>Github has lots of functionality to make this process easier,
including being able to mark scripts as ‘<em>Viewed</em>’ and limiting
changes to certain commits.</li>
<li>You should also run the code in R Studio and check the relevant QA
log has been updated.</li>
</ol></li>
<li><p>When you are ready click ‘<em>Finish your review</em>’ add a
summary comment and then click ‘<em>Submit review</em>’. You may choose
to leave comments to be responded to, suggest changes to be made or
simply approve the pull request straight away.</p>
<p><img src="assets/finish_review.png" width="311"
height="222" /></p></li>
</ol>
</details>
<p><br></p>
<p>The QAer should then write a summary of the checks performed. In
particular noting issues and any unusual checks that have had to be
performed in the process of QAing.</p>
</div>
<div id="merge-changes-into-dev-branch" class="section level2">
<h2>4. Merge changes into dev branch</h2>
<p>Once approved, changes should be merged into the dev branch. This may
require resolving merge conflicts.</p>
<details>
<summary>
How to merge
</summary>
<p><a id="how_to_merge"></a></p>
<ol style="list-style-type: decimal">
<li><p>Once your reviewer has inspected your code they may ask you some
questions or suggest some changes. Once you have responded to these they
will approve your pull request and you can merge your changes! This will
look like:</p>
<p><img src="assets/passed_pr_check.png" /></p>
<p><strong>Note</strong>: if any of the QA checklist items have been
left unchecked, GitHub will automatically block merging. It will look
like:</p>
<p><img src="assets/failed_pr_check.png" /></p></li>
<li><p>You will need to check there are no ‘merge conflicts’. This is
where someone has changed the same files as you and so you need to agree
with that person what are the correct changes and modify accordingly,
Github will read ‘<em>Able to merge</em>’ indicating there are no
conflicts.</p>
<p><img src="assets/ready_to_merge.png" /></p></li>
<li><p>If you are merging a new <strong>tagged version</strong> of the
model…</p>
<p><a id="model_tagging"></a></p>
<p>You will need to make sure:</p>
<ol style="list-style-type: decimal">
<li><p>You have changed the model_version parameter in
<code>run_LAPCAP_model</code> (in <code>main.R</code>) and the
model_version parameter in the data_pipeline function in
<code>update_data_pipeline.R</code>.</p>
<p><strong>Version numbers should follow this convention: in version
Vx.y.z,</strong></p>
<ul>
<li>The first number, x, should be updated when figures are published
externally (including publishing letters, use in public base fees
etc.)</li>
<li>The second number, y, should be updated when figures are shared
non-publically (e.g. with Simpler Recycling, MHCLG, DESNZ etc.)</li>
<li>The third number, z, should be updated when there are changes to the
data inputs or the data pipeline (to allow rolling back to the correct
data in the future)</li>
</ul></li>
<li><p>You have run the data pipeline with the new model_version
parameter to create a folder on the aws bucket containing all the data
for that version of the model (remembering to restart your R session and
clean your environment before running the pipeline) - see <a
href="#how_to_data_input">here</a> for full data pipeline
guidance</p></li>
<li><p>Ensure that the data pipeline and model both run correctly with
the new model_version parameter</p></li>
</ol>
<p>After merging you can then tag the commit on dev with the new model
version using GitHub’s tagging feature. If publishing externally and
updating the first number in the model version, you should open a PR and
merge dev into main, after signoff processes have been completed.</p>
<p>You should ensure that the rest of the team are aware of the version
being tagged so they can rebase their branches if necessary.</p></li>
<li><p>Finally you can delete the old, now redundant branch you were
working on!</p></li>
</ol>
</details>
<p><br></p>
<p>Finally the QA analyst (or the appropriate G7) will review the pull
requests on a weekly basis to ensure that they been done to a high
standard.and record them in the verification log <a
href="https://defra.sharepoint.com/:x:/r/teams/Team1478/Extended%20Producer%20Responsibility%20for%20Packaging/07%20Fees%20and%20Payments%20Calculator/18%20Module%20B1%20-%20LA%20FNCs/04%20Bottom-up%20Modelling/00%20Model%20Master/03%20LAPCAP%20Signoff%20Log.xlsm?d=w5065d9665d34493c92e1fca1ce67b2fd&amp;csf=1&amp;web=1&amp;e=3xjNJt">03
LAPCAP Signoff Log.xlsm</a>. This will allow us to effectively
communicate the steps taken to ensure quality with stakeholders and
inspire confidence.</p>
</div>
</div>
<div id="signoff-process-detail" class="section level1">
<h1>Signoff Process Detail</h1>
<div id="model-development-complete" class="section level2">
<h2>1. Model development complete</h2>
<p>Once all changes required for a publication or sharing of the model
are complete, the team will undertake the following steps.</p>
<p>Multiple pull requests will have been merged into dev (e.g. the above
coding process will have been repeated multiple times) and these will
all receive signoff together.</p>
<p>There are some circumstances where the full signoff may not be
required for instance, sharing the model internally, this is left to the
judgment of the model owner.</p>
</div>
<div id="model-owner-signoff" class="section level2">
<h2>2. Model owner signoff</h2>
<p>The <a
href="https://defra.sharepoint.com/:w:/r/teams/Team1478/Extended%20Producer%20Responsibility%20for%20Packaging/07%20Fees%20and%20Payments%20Calculator/18%20Module%20B1%20-%20LA%20FNCs/04%20Bottom-up%20Modelling/00%20Model%20Master/TEMPLATE%20model_owner_signoff_request.docx?d=w3162a6ece2984a77a4403747dbffba47&amp;csf=1&amp;web=1&amp;e=XhXJPj">TEMPLATE
model_owner_signoff_request.docx</a> should be used to request a sign
off from the model owner. It contains instructions for how to fill it
out.</p>
<p>The model owner should sign off on the following documents, which
should have been updated:</p>
<ul>
<li><p>Documentation</p>
<ul>
<li><p>Technical document</p></li>
<li><p>Assumptions logs &amp; accompanying evidence</p></li>
<li><p>Data logs</p></li>
<li><p>Verification log compiled by quality assurance lead</p></li>
</ul></li>
<li><p>Outputs</p>
<ul>
<li><p>Change log</p></li>
<li><p>Critical success factors markdown - which can be updated
following the steps under <a href="#how_to_validate">How to run
validation checks</a></p></li>
<li><p>The validation markdown - STILL BEING REVISED BY CAT</p></li>
</ul></li>
</ul>
<p>The model owner does not necessarily have to review all of these
themselves; they may utilise the advisory groups to offer assurance. For
instance, in the past TWG have assured on assumptions logs.</p>
<p>The model owner’s signoff for that model version should be recorded
in <a
href="https://defra.sharepoint.com/:x:/r/teams/Team1478/_layouts/15/Doc.aspx?sourcedoc=%7B5065D966-5D34-493C-92E1-FCA1CE67B2FD%7D&amp;file=TEMPLATE%20modulename%20assumptions_data_log1.xlsm&amp;action=default&amp;mobileredirect=true">03
LAPCAP Signoff Log</a>.</p>
</div>
<div id="sro-signoff" class="section level2">
<h2>3. SRO signoff</h2>
<p>PackUK Executive Committee, or pEPR Project Board in their absence,
acting on behalf of the model SROs, should signoff the model version for
publication.</p>
<p>It is unlikely that members of project board will review any of the
model or its documentation themselves, however copies should be shared
so they have the option to, and can delegate to members of their
organisation.</p>
<p>Instead, summaries of changes, visualisations of overall outputs and
assurances from advisory groups may be presented. Exactly what is
required may depend on the specific changes being signed off, so is left
up to the judgment of the model owner.</p>
<p>The paper or presentation submitted to the SROs should be approved by
Analytical Board in order to allow the SROs confidence in the analytical
quality of the model before formal approval for use.</p>
<p>There may be an additional stage of parameter setting, at this point
in the approvals process, especially for the first outputs for each new
year of EPR.</p>
<p>The project board signoff for that model version should be recorded
in <a
href="https://defra.sharepoint.com/:x:/r/teams/Team1478/_layouts/15/Doc.aspx?sourcedoc=%7B5065D966-5D34-493C-92E1-FCA1CE67B2FD%7D&amp;file=TEMPLATE%20modulename%20assumptions_data_log1.xlsm&amp;action=default&amp;mobileredirect=true">03
LAPCAP Signoff Log</a>.</p>
</div>
<div id="share-or-publish-outputs" class="section level2">
<h2>4. Share or publish outputs</h2>
<p>Once signed off and ready to share the dev branch should be merged
into main, tagged and versioned. External publication versions should
have the first version number update e.g. V5.2.1 becomes V6.0.0. The
model master folder should be updated accordingly.</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
